{% extends 'base.html' %}
{% block content %}

<h4 class="mb-3">Registro e Histórico de Consumo</h4>

<!-- Formulário para ADICIONAR NOVO CONSUMO -->
<form method="POST" class="card shadow-sm p-3 mb-3" style="background-color: #e9ecef; border-left: 4px solid #6c757d;">
    <h6 class="card-title mb-2">Adicionar Novo Consumo (Cerveja R$ {{ '%.2f'|format(valor_unit)|replace('.', ',') }})</h6>
    <input type="hidden" name="action" value="add_consumo">
    <div class="row g-2 align-items-end">
        <!-- Seleção da Pessoa por ID (name="pessoa_id" - CORRIGIDO) -->
        <div class="col-md-4">
            <select name="pessoa_id" class="form-select form-select-sm" required> 
                <option value="" disabled selected>Selecione a Pessoa (Apelido)</option>
                {% for p in pessoas %}
                    <option value="{{ p[0] }}">{{ p[2] }} ({{ p[1] }})</option>
                {% endfor %}
            </select>
        </div>
        <!-- Quantidade -->
        <div class="col-md-2">
            <input name="quantidade" type="number" min="1" class="form-control form-control-sm" placeholder="Qtd" value="1" required>
        </div>
        <!-- Data (AGORA USANDO data_hoje para preenchimento automático) -->
        <div class="col-md-3">
            <input name="data" type="date" class="form-control form-control-sm" value="{{ data_hoje or '' }}" required>
        </div>
        <!-- Botão de Registrar -->
        <div class="col-md-3 d-grid">
            <button class="btn rounded-pill btn-sm" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Registrar</button>
        </div>
    </div>
</form>

<!-- FORMULÁRIO DE FILTRO -->
<form method="GET" class="card shadow-sm p-3 mb-3">
    <h6 class="card-title mb-2">Filtros de Histórico</h6>
    <div class="row g-2 align-items-end">
        
        <!-- Lista Suspensa para Pessoa (igual ao card de adicionar) -->
        <div class="col-md-4">
            <label for="filtro_pessoa" class="form-label small">Filtrar por Pessoa:</label>
            <select name="pessoa_id" id="filtro_pessoa" class="form-select form-select-sm">
                <option value="">-- Todas as Pessoas --</option>
                {% for p in pessoas %}
                    <option value="{{ p[0] }}" 
                            {% if request.args.get('pessoa_id')|string == p[0]|string %}selected{% endif %}>
                        {{ p[2] }} ({{ p[1] }})
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Filtro por Data -->
        <div class="col-md-3">
            <label for="filtro_data" class="form-label small">Filtrar por Data:</label>
            <input type="date" name="data" id="filtro_data" class="form-control form-control-sm" value="{{ filtro_data or '' }}">
        </div>
        
        <!-- Botões de Ação -->
        <div class="col-md-5 d-flex gap-2 align-items-end">
            <button type="submit" class="btn rounded-pill btn-sm" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Aplicar Filtros</button>
            {% if request.args.get('pessoa_id') or filtro_data %}
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Limpar</a>
            {% endif %}
        </div>
    </div>
</form>

<!-- Tabela de Histórico de Consumo (Resultados Filtrados) -->
<div class="card shadow-sm p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="card-title mb-0 small fw-bold">Histórico de Consumo ({{ registros|length }} registros)</h6>
        <a href="{{ url_for('exportar_consumo') }}?pessoa_id={{ request.args.get('pessoa_id') }}&data={{ filtro_data }}" class="btn btn-success btn-sm rounded-pill px-3" style="padding: 0.2rem 0.8rem; font-size: 0.75rem;">Exportar</a>
    </div>
    <div class="table-responsive">
        <table class="table table-sm table-striped align-middle small">
            <thead>
                <tr>
                    <th>Apelido</th>
                    <th>Nome Completo</th>
                    <th>Qtd</th>
                    <th>Valor R$</th>
                    <th>Data</th>
                </tr>
            </thead>
            <tbody>
                {% for r in registros %}
                <!-- r[2]=apelido, r[1]=nome, r[5]=quantidade, r[7]=valor_total, r[4]=data -->
                <tr>
                    <td><strong>{{ r[2] }}</strong></td>
                    <td>{{ r[1] }}</td>
                    <td>{{ r[5] }}</td>
                    <td>R$ {{ '%.2f'|format(r[7])|replace('.', ',') }}</td>
                    <td>{{ r[4] | brdate }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

{% endblock content %}