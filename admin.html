{% extends 'base.html' %}
{% block content %}
<div class="card shadow-sm p-3 mb-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0 small fw-bold">Cadastro de Pessoas</h6>
    <div>
      <a href="{{ url_for('exportar_cadastros') }}" class="btn btn-success btn-sm rounded-pill" style="padding: 0.2rem 0.8rem; font-size: 0.75rem;">Exportar</a>
    </div>
  </div>
  <form method="POST" class="row g-2 mb-3">
    <input type="hidden" name="action" value="add_pessoa">
    <div class="col-md-4"><input name="nome" class="form-control form-control-sm" placeholder="Nome" required></div>
    <div class="col-md-3"><input name="apelido" class="form-control form-control-sm" placeholder="Apelido" required></div>
    <div class="col-md-3"><input name="celular" class="form-control form-control-sm" placeholder="Celular" required></div>
    <div class="col-md-2 d-grid"><button class="btn rounded-pill btn-sm" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Cadastrar</button></div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle small">
      <thead><tr><th>Nome</th><th>Apelido</th><th>Celular</th><th>Ações</th></tr></thead>
      <tbody>
        {% for p in pessoas %}
          <tr>
            <td>{{ p[1] }}</td><td>{{ p[2] }}</td><td>{{ p[3] }}</td>
            <td>
              <form method="POST" action="{{ url_for('excluir_pessoa', id=p[0]) }}" style="display:inline" onsubmit="return confirm('Confirma exclusão?')">
                <button class="btn btn-danger btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Excluir</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Filtros para Consumos -->
<div class="card shadow-sm p-3 mb-3">
  <h6 class="mb-2 small fw-bold">Filtros de Consumos</h6>
  <form method="GET" class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label small">Filtrar por Apelido:</label>
      <select name="filtro_nome" class="form-select form-select-sm">
        <option value="">-- Todos os Nomes --</option>
        {% for apelido in pessoas_unicas %}
          <option value="{{ apelido }}" {% if filtro_apelido == apelido %}selected{% endif %}>{{ apelido }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label small">Filtrar por Data:</label>
      <input type="date" name="filtro_data_consumo" class="form-control form-control-sm" value="{{ filtro_data_consumo or '' }}">
    </div>
    <div class="col-md-4 d-flex gap-2">
      <button type="submit" class="btn rounded-pill btn-sm" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Aplicar Filtros</button>
      {% if filtro_apelido or filtro_data_consumo %}
      <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Limpar</a>
      {% endif %}
    </div>
  </form>
</div>

<div class="card shadow-sm p-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0 small fw-bold">Consumos</h6>
  </div>
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle small">
      <thead><tr><th>Nome</th><th>Data</th><th>Qtd</th><th>Total (R$)</th><th></th></tr></thead>
      <tbody>
        {% for c in consumos %}
          <tr>
            <td>{{ c[1] }}</td><td>{{ c[2][8:10] }}/{{ c[2][5:7] }}/{{ c[2][0:4] }}</td><td>{{ c[3] }}</td><td>R$ {{ '%.2f'|format(c[4])|replace('.', ',') }}</td>
            <td>
              <form method="POST" action="{{ url_for('excluir_consumo', id=c[0]) }}" style="display:inline" onsubmit="return confirm('Confirma exclusão deste consumo?')">
                <button class="btn btn-danger btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Excluir</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Filtro para Consumo por Data -->
<div class="card shadow-sm p-3 mt-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="mb-0 small fw-bold">Consumo por Data</h6>
    <form method="GET" class="d-flex gap-2">
      <input type="date" name="filtro_data_agregada" class="form-control form-control-sm" value="{{ filtro_data_agregada or '' }}" style="width: 140px;">
      <button type="submit" class="btn rounded-pill btn-sm" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Filtrar</button>
      {% if filtro_data_agregada %}
      <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Limpar</a>
      {% endif %}
    </form>
  </div>
  <div class="table-responsive mt-2">
    <table class="table table-sm table-striped small">
      <thead><tr><th>Data</th><th>Qtd Total</th><th>Valor Total (R$)</th><th></th></tr></thead>
      <tbody>
        {% for d in consumo_por_data %}
          <tr>
            <td>{{ d[0][8:10] }}/{{ d[0][5:7] }}/{{ d[0][0:4] }}</td>
            <td>{{ d[1] }}</td>
            <td>R$ {{ '%.2f'|format(d[2])|replace('.', ',') }}</td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="{{ url_for('index') }}?data={{ d[0] }}" class="btn rounded-pill" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Visualizar</a>
                <a href="{{ url_for('exportar_consumo') }}?data={{ d[0] }}" class="btn btn-success rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Exportar</a>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="card shadow-sm p-3 mt-3">
  <h6 class="mb-0 small fw-bold">Administradores</h6>
  
  <!-- Formulário para cadastrar novo admin -->
  <form method="POST" action="{{ url_for('add_admin') }}" class="row g-2 mb-2">
    <div class="col-md-4">
      <input name="usuario" class="form-control form-control-sm" placeholder="Celular (11 dígitos)" required pattern="[0-9]{11}" title="Digite exatamente 11 dígitos">
    </div>
    <div class="col-md-4">
      <input name="email" type="email" class="form-control form-control-sm" placeholder="E-mail para criar senha" required>
    </div>
    <div class="col-md-4 d-grid">
      <button class="btn rounded-pill btn-sm" style="background-color: #495057; color: white; border: none; padding: 0.2rem 0.6rem; font-size: 0.75rem;">Cadastrar Admin</button>
    </div>
  </form>

  <!-- GESTÃO DE SENHA APENAS PARA O PRÓPRIO USUÁRIO -->
  <div class="card bg-light mt-3 mb-3">
    <div class="card-body p-3">
      <h6 class="mb-2 small fw-bold">Minha Conta ({{ session.get('admin') }})</h6>
      
      <!-- Alterar senha atual -->
      <form method="POST" action="{{ url_for('change_my_password') }}" class="row g-2 mb-2">
        <div class="col-md-4">
          <input name="nova_senha" type="password" class="form-control form-control-sm" placeholder="Nova Senha" required>
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-info btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Alterar Minha Senha</button>
        </div>
        <div class="col-md-4">
          <small class="text-muted">Altere sua senha atual</small>
        </div>
      </form>

      <!-- Resetar senha (esqueci a senha) -->
      <form method="POST" action="{{ url_for('resetar_minha_senha') }}" class="row g-2">
        <div class="col-md-8">
          <small class="text-muted">Esqueceu sua senha? Receba um link para criar uma nova</small>
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-warning btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Resetar Minha Senha</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lista de administradores -->
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle small">
      <thead>
        <tr>
          <th>Usuário</th>
          <th>E-mail</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for a in admins %}
          <tr>
            <td>
              {{ a[1] }}
              {% if a[0] == session.get('admin_id') %}
                <span class="badge bg-primary ms-1">Você</span>
              {% endif %}
            </td>
            <td>{{ a[2] or 'N/A' }}</td>
            <td>
              {% if a[3] %}
                <span class="badge bg-success">Ativo</span>
              {% else %}
                <span class="badge bg-warning">Sem senha</span>
              {% endif %}
            </td>
            <td>
              {% if a[0] != session.get('admin_id') %}
              <form method="POST" action="{{ url_for('excluir_admin', id=a[0]) }}" style="display:inline" onsubmit="return confirm('Confirma exclusão deste administrador?')">
                <button class="btn btn-danger btn-sm rounded-pill" style="padding: 0.2rem 0.6rem; font-size: 0.75rem;">Excluir</button>
              </form>
              {% else %}
              <span class="text-muted small">Sua conta</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock content %}